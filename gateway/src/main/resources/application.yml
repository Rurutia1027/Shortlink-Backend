server:
  port: 8080

spring:
  application:
    name: shortlink-gateway
  # Force reactive web application type (required for Spring Cloud Gateway)
  # This prevents Spring MVC from being auto-configured when base module brings in spring-boot-starter-web
  main:
    web-application-type: reactive

  cloud:
    gateway:
      # Global CORS configuration
      globalcors:
        cors-configurations:
          '[/**]':
            # Use allowedOriginPatterns instead of allowedOrigins when allowCredentials is true
            # This allows wildcard patterns while still supporting credentials
            allowedOriginPatterns:
              - "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      # Route configuration
      # IMPORTANT: Routes are matched in order. More specific routes should come first.
      routes:
        # Restore URL route (short URI redirect) - highest priority, most specific
        # Must come before shortlink-service to avoid conflicts
        - id: restore-url
          uri: ${GATEWAY_SHORTLINK_URI:http://localhost:8081}
          predicates:
            - Path=/api/shortlink/v1/{shortUri}
            - Method=GET
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: ${GATEWAY_RATE_LIMIT_RESTORE:1000}
                redis-rate-limiter.burstCapacity: ${GATEWAY_RATE_LIMIT_RESTORE_BURST:2000}
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"

        # Admin service route - must come before shortlink-service
        # Routes all /api/shortlink/admin/** requests to admin service (8082)
        # Includes: user (login, register, etc.), group, recycle-bin, and admin shortlink operations
        - id: admin-service
          uri: ${GATEWAY_ADMIN_URI:http://localhost:8082}
          predicates:
            - Path=/api/shortlink/admin/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: ${GATEWAY_RATE_LIMIT_ADMIN:10}
                redis-rate-limiter.burstCapacity: ${GATEWAY_RATE_LIMIT_ADMIN_BURST:20}
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: WhitelistFilter
              args:
                enabled: ${GATEWAY_WHITELIST_ENABLED:false}

        # Shortlink service route - catch-all for /api/shortlink/** (except admin and restore-url)
        # Routes to shortlink service (8081) for direct shortlink operations
        - id: shortlink-service
          uri: ${GATEWAY_SHORTLINK_URI:http://localhost:8081}
          predicates:
            - Path=/api/shortlink/**
          filters:
            - StripPrefix=0
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: ${GATEWAY_RATE_LIMIT_SHORTLINK:100}
                redis-rate-limiter.burstCapacity: ${GATEWAY_RATE_LIMIT_SHORTLINK_BURST:200}
                redis-rate-limiter.requestedTokens: 1
                key-resolver: "#{@ipKeyResolver}"
            - name: WhitelistFilter
              args:
                enabled: ${GATEWAY_WHITELIST_ENABLED:false}

      # Default filters (applied to all routes)
      # Note: Global filters are automatically applied, no need to list here

  # Redis configuration for rate limiting
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:StrongRedisPass123!}
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0
          max-wait: 3000ms

# Actuator endpoints
management:
  endpoints:
    web:
      exposure:
        include: health,info,gateway
      base-path: /actuator
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

# Logging
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    org.tus.shortlink.gateway: DEBUG
    reactor.netty: INFO
